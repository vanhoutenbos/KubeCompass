# ArgoCD Installation Manifest
# Version: 2.9.3 (stable)
# Source: https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

apiVersion: v1
kind: Namespace
metadata:
  name: argocd
  labels:
    name: argocd
    managed-by: kubectl

---
# NOTE: Full ArgoCD installation is managed via official manifests
# Download the latest stable version:
# kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# This file contains the namespace and custom configurations only
# For production, download and commit the full install.yaml for version control

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  # Enable auto-sync for dev and staging
  application.instanceLabelKey: argocd.argoproj.io/instance
  
  # Repository credentials (use external secrets for production)
  repositories: |
    - url: https://github.com/vanhoutenbos/KubeCompass.git
      name: kubecompass
      type: git
  
  # SSO configuration (OIDC)
  # url: https://argocd.webshop.example.com
  # dex.config: |
  #   connectors:
  #     - type: oidc
  #       id: oidc
  #       name: SSO
  #       config:
  #         issuer: https://sso.webshop.example.com
  #         clientID: argocd
  #         clientSecret: $oidc.clientSecret
  #         redirectURI: https://argocd.webshop.example.com/api/dex/callback

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
data:
  # RBAC policy
  policy.default: role:readonly
  
  # Custom roles
  policy.csv: |
    # Developers: Read-only in production, write in dev/staging
    p, role:developer, applications, get, */*, allow
    p, role:developer, applications, sync, dev/*, allow
    p, role:developer, applications, sync, staging/*, allow
    p, role:developer, repositories, get, *, allow
    p, role:developer, clusters, get, *, allow
    
    # Platform Engineers: Full access
    p, role:platform-engineer, applications, *, */*, allow
    p, role:platform-engineer, repositories, *, *, allow
    p, role:platform-engineer, clusters, *, *, allow
    p, role:platform-engineer, accounts, *, *, allow
    
    # Operations: Production sync only
    p, role:operations, applications, get, */*, allow
    p, role:operations, applications, sync, production/*, allow
    p, role:operations, applications, override, production/*, allow
    
    # Group mappings (via SSO)
    g, platform-team, role:platform-engineer
    g, dev-team, role:developer
    g, ops-team, role:operations

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cmd-params-cm
    app.kubernetes.io/part-of: argocd
data:
  # Server configuration
  server.insecure: "false"
  server.rootpath: "/"
  
  # Application controller
  application.namespaces: "argocd,platform,observability,security,applications,backup"
  
  # Repo server
  reposerver.parallelism.limit: "10"
  
  # Timeout settings
  timeout.reconciliation: "180s"
  timeout.hard.reconciliation: "0"

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-server
  namespace: argocd
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - argocd.webshop.example.com
    secretName: argocd-server-tls
  rules:
  - host: argocd.webshop.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: argocd-server
            port:
              number: 443
