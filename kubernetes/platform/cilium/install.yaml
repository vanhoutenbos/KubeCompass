# Cilium CNI Installation
# Installed via Helm, this file documents the configuration

apiVersion: v1
kind: Namespace
metadata:
  name: kube-system
  labels:
    name: kube-system

---
# Cilium Helm installation commands:
# 
# helm repo add cilium https://helm.cilium.io/
# helm repo update
# 
# helm install cilium cilium/cilium --version 1.14.5 \
#   --namespace kube-system \
#   --set operator.replicas=2 \
#   --set hubble.enabled=true \
#   --set hubble.relay.enabled=true \
#   --set hubble.ui.enabled=true \
#   --set hubble.metrics.enabled="{dns,drop,tcp,flow,port-distribution,icmp,http}" \
#   --set ipam.mode=kubernetes \
#   --set kubeProxyReplacement=strict \
#   --set k8sServiceHost=API_SERVER_IP \
#   --set k8sServicePort=6443 \
#   --set l7Proxy=true \
#   --set bpf.masquerade=true

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cilium-config
  namespace: kube-system
data:
  # Cilium configuration values (for reference)
  config.yaml: |
    # Identity allocation mode
    identity-allocation-mode: crd
    
    # Enable Hubble
    enable-hubble: true
    hubble-listen-address: ":4244"
    hubble-socket-path: /var/run/cilium/hubble.sock
    
    # Network policies
    enable-policy: "default"
    enable-l7-proxy: true
    
    # eBPF configuration
    enable-bpf-masquerade: true
    enable-ipv4-masquerade: true
    
    # Performance
    preallocate-bpf-maps: true
    
    # Security
    enable-endpoint-health-checking: true
    
    # Observability
    enable-metrics: true
    prometheus-serve-addr: ":9090"

---
# Hubble UI Service (for port-forwarding)
apiVersion: v1
kind: Service
metadata:
  name: hubble-ui
  namespace: kube-system
  labels:
    app.kubernetes.io/name: hubble-ui
    app.kubernetes.io/part-of: cilium
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 80
    targetPort: 8081
  selector:
    app.kubernetes.io/name: hubble-ui

---
# Network Policy for Hubble UI (access only from ops)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hubble-ui-access
  namespace: kube-system
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: hubble-ui
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 8081

---
# ServiceMonitor for Prometheus (if using Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cilium-agent
  namespace: kube-system
  labels:
    app.kubernetes.io/name: cilium-agent
    app.kubernetes.io/part-of: cilium
spec:
  selector:
    matchLabels:
      k8s-app: cilium
  endpoints:
  - port: prometheus
    interval: 30s
    path: /metrics

---
# ServiceMonitor for Hubble
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: hubble
  namespace: kube-system
  labels:
    app.kubernetes.io/name: hubble
    app.kubernetes.io/part-of: cilium
spec:
  selector:
    matchLabels:
      k8s-app: hubble
  endpoints:
  - port: prometheus
    interval: 30s
    path: /metrics
