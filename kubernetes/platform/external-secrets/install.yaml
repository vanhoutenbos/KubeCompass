# External Secrets Operator Installation
# Syncs secrets from external secret managers (Vault, cloud KMS)

---
# Install via Helm:
# helm repo add external-secrets https://charts.external-secrets.io
# helm repo update
# 
# helm install external-secrets external-secrets/external-secrets \
#   --namespace external-secrets-system \
#   --create-namespace

apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets-system
  labels:
    name: external-secrets-system

---
# SecretStore for HashiCorp Vault
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: webshop
spec:
  provider:
    vault:
      server: "https://vault.webshop.example.com"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "webshop-role"
          serviceAccountRef:
            name: webshop-sa

---
# ClusterSecretStore for cloud provider (alternative to Vault)
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: cloud-secrets
spec:
  provider:
    # Example: AWS Secrets Manager
    aws:
      service: SecretsManager
      region: eu-west-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets-system

---
# ExternalSecret for Database Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: webshop
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  
  target:
    name: database-credentials
    creationPolicy: Owner
  
  data:
  - secretKey: username
    remoteRef:
      key: database/postgres
      property: username
  
  - secretKey: password
    remoteRef:
      key: database/postgres
      property: password
  
  - secretKey: connection-string
    remoteRef:
      key: database/postgres
      property: connection_string

---
# ExternalSecret for Payment API Key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: payment-api-key
  namespace: webshop
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  
  target:
    name: payment-api-key
    creationPolicy: Owner
  
  data:
  - secretKey: api-key
    remoteRef:
      key: external-apis/payment
      property: api_key
  
  - secretKey: api-secret
    remoteRef:
      key: external-apis/payment
      property: api_secret

---
# ExternalSecret for Harbor Registry Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: harbor-registry-credentials
  namespace: webshop
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  
  target:
    name: harbor-registry-credentials
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "harbor.webshop.example.com": {
                "username": "{{ .username }}",
                "password": "{{ .password }}",
                "auth": "{{ printf "%s:%s" .username .password | b64enc }}"
              }
            }
          }
  
  data:
  - secretKey: username
    remoteRef:
      key: harbor/robot-account
      property: username
  
  - secretKey: password
    remoteRef:
      key: harbor/robot-account
      property: password

---
# ServiceAccount for External Secrets Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: external-secrets-system

---
# ClusterRole for External Secrets Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-secrets-operator
rules:
- apiGroups: [""]
  resources: ["secrets", "configmaps", "serviceaccounts"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets", "secretstores", "clustersecretstores"]
  verbs: ["get", "list", "watch", "update", "patch"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets/status", "secretstores/status", "clustersecretstores/status"]
  verbs: ["get", "update", "patch"]

---
# ClusterRoleBinding for External Secrets Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-secrets-operator
subjects:
- kind: ServiceAccount
  name: external-secrets-sa
  namespace: external-secrets-system
roleRef:
  kind: ClusterRole
  name: external-secrets-operator
  apiGroup: rbac.authorization.k8s.io

---
# ServiceMonitor for Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: external-secrets-operator
  namespace: external-secrets-system
  labels:
    app: external-secrets
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: external-secrets
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
