# Pod Exec Restricted Role
# Can view logs and port-forward, but no shell access
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-exec-restricted
  namespace: webshop
  labels:
    rbac.kubecompass.io/role-type: debug-restricted
  annotations:
    description: "Debug access without shell execution"
rules:
# Read pods
- apiGroups: [""]
  resources: ["pods", "pods/status"]
  verbs: ["get", "list", "watch"]

# View logs
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get", "list"]

# Port-forward for debugging
- apiGroups: [""]
  resources: ["pods/portforward"]
  verbs: ["create"]

# NO exec or attach (security requirement)
# - apiGroups: [""]
#   resources: ["pods/exec", "pods/attach"]
#   verbs: ["create"]

# Read deployments to understand context
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "statefulsets"]
  verbs: ["get", "list", "watch"]

# Read services
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pod-exec-restricted-binding
  namespace: webshop
  labels:
    rbac.kubecompass.io/role-type: debug-restricted
subjects:
- kind: Group
  name: "team-platform-junior-devs"
  apiGroup: rbac.authorization.k8s.io

- kind: Group
  name: "team-platform-external-contractors"
  apiGroup: rbac.authorization.k8s.io

roleRef:
  kind: Role
  name: pod-exec-restricted
  apiGroup: rbac.authorization.k8s.io
